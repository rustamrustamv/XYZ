---
- name: Build and push Docker image
  hosts: localhost
  connection: local
  vars:
    image_name: "rustamrustamov/xyz_tech"
    build_number: "{{ lookup('env','BUILD_NUMBER') | default('latest') }}"
    workspace: "{{ lookup('env','WORKSPACE') | default('.') }}"

  tasks:
    - name: Copy WAR file to standard location
      copy:
        src: "{{ workspace }}/target/XYZtechnologies-1.0.war"
        dest: "{{ workspace }}/xyz.war"
        remote_src: yes

    - name: Build Docker image
      community.docker.docker_image:
        build:
          path: "{{ workspace }}"
        name: "{{ image_name }}"
        tag: "{{ build_number }}"
        push: no

    - name: Tag Docker image as latest
      command: docker tag {{ image_name }}:{{ build_number }} {{ image_name }}:latest

    - name: Push Docker image with build number tag
      community.docker.docker_image:
        name: "{{ image_name }}"
        tag: "{{ build_number }}"
        push: yes

    - name: Push Docker image with latest tag
      community.docker.docker_image:
        name: "{{ image_name }}"
        tag: latest
        push: yes
